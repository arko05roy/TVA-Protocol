"use strict";
/**
 * ASTRAEUS - Cryptographic Utilities
 *
 * Implements SHA-256 hashing as specified in agent/interfaces.md
 * CRITICAL: All hashes MUST use SHA-256, NOT keccak256
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.sha256 = sha256;
exports.computeAssetId = computeAssetId;
exports.computeMemo = computeMemo;
exports.bigintToBuffer = bigintToBuffer;
exports.bufferToBigint = bufferToBigint;
exports.stellarKeyToRaw = stellarKeyToRaw;
exports.rawToStellarKey = rawToStellarKey;
exports.hexToStellarKey = hexToStellarKey;
exports.isValidStellarPublicKey = isValidStellarPublicKey;
exports.computeBalanceLeaf = computeBalanceLeaf;
exports.computeWithdrawalLeaf = computeWithdrawalLeaf;
const crypto_1 = require("crypto");
const stellar_sdk_1 = require("@stellar/stellar-sdk");
/**
 * Compute SHA-256 hash
 */
function sha256(data) {
    return (0, crypto_1.createHash)('sha256').update(data).digest();
}
/**
 * Compute asset_id as specified in interfaces.md Section 2.2
 *
 * asset_id = SHA256(asset_code || issuer)
 *
 * @param assetCode - Asset code (1-12 alphanumeric, UTF-8 encoded, null-terminated)
 * @param issuer - "NATIVE" for XLM, or raw 32-byte Ed25519 public key for issued assets
 * @returns 32-byte asset ID as hex string (64 lowercase hex characters)
 */
function computeAssetId(assetCode, issuer) {
    // Asset code: UTF-8 encoded, null-terminated
    const assetCodeBytes = Buffer.concat([
        Buffer.from(assetCode, 'utf-8'),
        Buffer.from([0x00]), // null terminator
    ]);
    let issuerBytes;
    if (issuer.toUpperCase() === 'NATIVE') {
        // For XLM: "NATIVE" as UTF-8 (6 bytes: 0x4E 0x41 0x54 0x49 0x56 0x45)
        issuerBytes = Buffer.from('NATIVE', 'utf-8');
    }
    else if (issuer.startsWith('G')) {
        // Stellar public key (G... format) - decode to raw 32 bytes
        issuerBytes = Buffer.from(stellar_sdk_1.StrKey.decodeEd25519PublicKey(issuer));
    }
    else if (issuer.startsWith('0x')) {
        // Raw hex format (from Dev A's contract)
        issuerBytes = Buffer.from(issuer.slice(2), 'hex');
    }
    else {
        // Assume raw hex without 0x prefix
        issuerBytes = Buffer.from(issuer, 'hex');
    }
    // Concatenate and hash
    const input = Buffer.concat([assetCodeBytes, issuerBytes]);
    const hash = sha256(input);
    return hash.toString('hex').toLowerCase();
}
/**
 * Compute memo as specified in interfaces.md Section 3
 *
 * memo = first_28_bytes(SHA256(subnet_id || block_number))
 *
 * @param subnetId - 32-byte subnet ID (bytes32, hex string with 0x prefix or raw hex)
 * @param blockNumber - Block number (uint64)
 * @returns 28-byte memo as Buffer
 */
function computeMemo(subnetId, blockNumber) {
    // subnet_id: 32 bytes
    const subnetIdHex = subnetId.startsWith('0x') ? subnetId.slice(2) : subnetId;
    if (subnetIdHex.length !== 64) {
        throw new Error(`Invalid subnet_id length: expected 64 hex chars, got ${subnetIdHex.length}`);
    }
    const subnetIdBytes = Buffer.from(subnetIdHex, 'hex');
    // block_number: uint64 big-endian (8 bytes)
    const blockNumberBytes = Buffer.alloc(8);
    blockNumberBytes.writeBigUInt64BE(blockNumber);
    // Concatenate (40 bytes total)
    const input = Buffer.concat([subnetIdBytes, blockNumberBytes]);
    // SHA-256 hash and take first 28 bytes
    const fullHash = sha256(input);
    return fullHash.subarray(0, 28);
}
/**
 * Convert a bigint to a big-endian Buffer of specified length
 */
function bigintToBuffer(value, length) {
    const hex = value.toString(16).padStart(length * 2, '0');
    return Buffer.from(hex, 'hex');
}
/**
 * Convert a Buffer to bigint (big-endian)
 */
function bufferToBigint(buffer) {
    return BigInt('0x' + buffer.toString('hex'));
}
/**
 * Convert Stellar public key (G...) to raw 32-byte Ed25519 key
 */
function stellarKeyToRaw(publicKey) {
    if (!publicKey.startsWith('G')) {
        throw new Error('Invalid Stellar public key format');
    }
    return Buffer.from(stellar_sdk_1.StrKey.decodeEd25519PublicKey(publicKey));
}
/**
 * Convert raw 32-byte Ed25519 key to Stellar public key (G...)
 */
function rawToStellarKey(rawKey) {
    if (rawKey.length !== 32) {
        throw new Error('Invalid raw key length: expected 32 bytes');
    }
    return stellar_sdk_1.StrKey.encodeEd25519PublicKey(rawKey);
}
/**
 * Convert hex string (with or without 0x) to Stellar public key
 */
function hexToStellarKey(hex) {
    const cleanHex = hex.startsWith('0x') ? hex.slice(2) : hex;
    if (cleanHex.length !== 64) {
        throw new Error(`Invalid hex length: expected 64, got ${cleanHex.length}`);
    }
    return rawToStellarKey(Buffer.from(cleanHex, 'hex'));
}
/**
 * Validate that a string is a valid Stellar public key
 */
function isValidStellarPublicKey(key) {
    try {
        stellar_sdk_1.StrKey.decodeEd25519PublicKey(key);
        return true;
    }
    catch {
        return false;
    }
}
/**
 * Compute balance leaf hash as specified in interfaces.md Section 1.3
 *
 * balance_leaf = SHA256("BAL" || user_id || asset_code || issuer || balance)
 */
function computeBalanceLeaf(userId, assetCode, issuer, balance) {
    // Prefix: "BAL" (3 bytes: 0x42 0x41 0x4C)
    const prefix = Buffer.from('BAL', 'utf-8');
    // user_id: 32 bytes
    const userIdHex = userId.startsWith('0x') ? userId.slice(2) : userId;
    const userIdBytes = Buffer.from(userIdHex, 'hex');
    // asset_code: UTF-8 encoded, null-terminated
    const assetCodeBytes = Buffer.concat([
        Buffer.from(assetCode, 'utf-8'),
        Buffer.from([0x00]),
    ]);
    // issuer: "NATIVE" for XLM or 32-byte Ed25519 public key
    let issuerBytes;
    if (issuer.toUpperCase() === 'NATIVE') {
        issuerBytes = Buffer.from('NATIVE', 'utf-8');
    }
    else if (issuer.startsWith('G')) {
        issuerBytes = Buffer.from(stellar_sdk_1.StrKey.decodeEd25519PublicKey(issuer));
    }
    else if (issuer.startsWith('0x')) {
        issuerBytes = Buffer.from(issuer.slice(2), 'hex');
    }
    else {
        issuerBytes = Buffer.from(issuer, 'hex');
    }
    // balance: 16 bytes big-endian int128
    const balanceBytes = bigintToBuffer(balance, 16);
    // Concatenate and hash
    const input = Buffer.concat([prefix, userIdBytes, assetCodeBytes, issuerBytes, balanceBytes]);
    return sha256(input).toString('hex').toLowerCase();
}
/**
 * Compute withdrawal leaf hash as specified in interfaces.md Section 1.4
 *
 * withdrawal_leaf = SHA256("WD" || withdrawal_id || user_id || asset_code || issuer || amount || destination)
 */
function computeWithdrawalLeaf(withdrawalId, userId, assetCode, issuer, amount, destination) {
    // Prefix: "WD" (2 bytes: 0x57 0x44)
    const prefix = Buffer.from('WD', 'utf-8');
    // withdrawal_id: 32 bytes
    const withdrawalIdHex = withdrawalId.startsWith('0x') ? withdrawalId.slice(2) : withdrawalId;
    const withdrawalIdBytes = Buffer.from(withdrawalIdHex, 'hex');
    // user_id: 32 bytes
    const userIdHex = userId.startsWith('0x') ? userId.slice(2) : userId;
    const userIdBytes = Buffer.from(userIdHex, 'hex');
    // asset_code: UTF-8 encoded, null-terminated
    const assetCodeBytes = Buffer.concat([
        Buffer.from(assetCode, 'utf-8'),
        Buffer.from([0x00]),
    ]);
    // issuer
    let issuerBytes;
    if (issuer.toUpperCase() === 'NATIVE') {
        issuerBytes = Buffer.from('NATIVE', 'utf-8');
    }
    else if (issuer.startsWith('G')) {
        issuerBytes = Buffer.from(stellar_sdk_1.StrKey.decodeEd25519PublicKey(issuer));
    }
    else if (issuer.startsWith('0x')) {
        issuerBytes = Buffer.from(issuer.slice(2), 'hex');
    }
    else {
        issuerBytes = Buffer.from(issuer, 'hex');
    }
    // amount: 16 bytes big-endian int128
    const amountBytes = bigintToBuffer(amount, 16);
    // destination: 32 bytes Ed25519 public key
    let destinationBytes;
    if (destination.startsWith('G')) {
        destinationBytes = Buffer.from(stellar_sdk_1.StrKey.decodeEd25519PublicKey(destination));
    }
    else if (destination.startsWith('0x')) {
        destinationBytes = Buffer.from(destination.slice(2), 'hex');
    }
    else {
        destinationBytes = Buffer.from(destination, 'hex');
    }
    // Concatenate and hash
    const input = Buffer.concat([
        prefix,
        withdrawalIdBytes,
        userIdBytes,
        assetCodeBytes,
        issuerBytes,
        amountBytes,
        destinationBytes,
    ]);
    return sha256(input).toString('hex').toLowerCase();
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY3J5cHRvLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vc3JjL2ludGVyZmFjZXMvY3J5cHRvLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7QUFRSCx3QkFFQztBQVdELHdDQTJCQztBQVdELGtDQWtCQztBQUtELHdDQUdDO0FBS0Qsd0NBRUM7QUFLRCwwQ0FLQztBQUtELDBDQUtDO0FBS0QsMENBTUM7QUFLRCwwREFPQztBQU9ELGdEQXFDQztBQU9ELHNEQTZEQztBQXJQRCxtQ0FBb0M7QUFDcEMsc0RBQThDO0FBRTlDOztHQUVHO0FBQ0gsU0FBZ0IsTUFBTSxDQUFDLElBQVk7SUFDakMsT0FBTyxJQUFBLG1CQUFVLEVBQUMsUUFBUSxDQUFDLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDO0FBQ3BELENBQUM7QUFFRDs7Ozs7Ozs7R0FRRztBQUNILFNBQWdCLGNBQWMsQ0FBQyxTQUFpQixFQUFFLE1BQWM7SUFDOUQsNkNBQTZDO0lBQzdDLE1BQU0sY0FBYyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDbkMsTUFBTSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsT0FBTyxDQUFDO1FBQy9CLE1BQU0sQ0FBQyxJQUFJLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLGtCQUFrQjtLQUN4QyxDQUFDLENBQUM7SUFFSCxJQUFJLFdBQW1CLENBQUM7SUFDeEIsSUFBSSxNQUFNLENBQUMsV0FBVyxFQUFFLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDdEMsc0VBQXNFO1FBQ3RFLFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxPQUFPLENBQUMsQ0FBQztJQUMvQyxDQUFDO1NBQU0sSUFBSSxNQUFNLENBQUMsVUFBVSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7UUFDbEMsNERBQTREO1FBQzVELFdBQVcsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLG9C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QyxnQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLEVBQUUsS0FBSyxDQUFDLENBQUM7SUFDOUQsQ0FBQztTQUFNLENBQUM7UUFDTixnQkFBZ0IsR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLFdBQVcsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNyRCxDQUFDO0lBRUQsdUJBQXVCO0lBQ3ZCLE1BQU0sS0FBSyxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUM7UUFDMUIsTUFBTTtRQUNOLGlCQUFpQjtRQUNqQixXQUFXO1FBQ1gsY0FBYztRQUNkLFdBQVc7UUFDWCxXQUFXO1FBQ1gsZ0JBQWdCO0tBQ2pCLENBQUMsQ0FBQztJQUNILE9BQU8sTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztBQUNyRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBBU1RSQUVVUyAtIENyeXB0b2dyYXBoaWMgVXRpbGl0aWVzXG4gKlxuICogSW1wbGVtZW50cyBTSEEtMjU2IGhhc2hpbmcgYXMgc3BlY2lmaWVkIGluIGFnZW50L2ludGVyZmFjZXMubWRcbiAqIENSSVRJQ0FMOiBBbGwgaGFzaGVzIE1VU1QgdXNlIFNIQS0yNTYsIE5PVCBrZWNjYWsyNTZcbiAqL1xuXG5pbXBvcnQgeyBjcmVhdGVIYXNoIH0gZnJvbSAnY3J5cHRvJztcbmltcG9ydCB7IFN0cktleSB9IGZyb20gJ0BzdGVsbGFyL3N0ZWxsYXItc2RrJztcblxuLyoqXG4gKiBDb21wdXRlIFNIQS0yNTYgaGFzaFxuICovXG5leHBvcnQgZnVuY3Rpb24gc2hhMjU2KGRhdGE6IEJ1ZmZlcik6IEJ1ZmZlciB7XG4gIHJldHVybiBjcmVhdGVIYXNoKCdzaGEyNTYnKS51cGRhdGUoZGF0YSkuZGlnZXN0KCk7XG59XG5cbi8qKlxuICogQ29tcHV0ZSBhc3NldF9pZCBhcyBzcGVjaWZpZWQgaW4gaW50ZXJmYWNlcy5tZCBTZWN0aW9uIDIuMlxuICpcbiAqIGFzc2V0X2lkID0gU0hBMjU2KGFzc2V0X2NvZGUgfHwgaXNzdWVyKVxuICpcbiAqIEBwYXJhbSBhc3NldENvZGUgLSBBc3NldCBjb2RlICgxLTEyIGFscGhhbnVtZXJpYywgVVRGLTggZW5jb2RlZCwgbnVsbC10ZXJtaW5hdGVkKVxuICogQHBhcmFtIGlzc3VlciAtIFwiTkFUSVZFXCIgZm9yIFhMTSwgb3IgcmF3IDMyLWJ5dGUgRWQyNTUxOSBwdWJsaWMga2V5IGZvciBpc3N1ZWQgYXNzZXRzXG4gKiBAcmV0dXJucyAzMi1ieXRlIGFzc2V0IElEIGFzIGhleCBzdHJpbmcgKDY0IGxvd2VyY2FzZSBoZXggY2hhcmFjdGVycylcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNvbXB1dGVBc3NldElkKGFzc2V0Q29kZTogc3RyaW5nLCBpc3N1ZXI6IHN0cmluZyk6IHN0cmluZyB7XG4gIC8vIEFzc2V0IGNvZGU6IFVURi04IGVuY29kZWQsIG51bGwtdGVybWluYXRlZFxuICBjb25zdCBhc3NldENvZGVCeXRlcyA9IEJ1ZmZlci5jb25jYXQoW1xuICAgIEJ1ZmZlci5mcm9tKGFzc2V0Q29kZSwgJ3V0Zi04JyksXG4gICAgQnVmZmVyLmZyb20oWzB4MDBdKSwgLy8gbnVsbCB0ZXJtaW5hdG9yXG4gIF0pO1xuXG4gIGxldCBpc3N1ZXJCeXRlczogQnVmZmVyO1xuICBpZiAoaXNzdWVyLnRvVXBwZXJDYXNlKCkgPT09ICdOQVRJVkUnKSB7XG4gICAgLy8gRm9yIFhMTTogXCJOQVRJVkVcIiBhcyBVVEYtOCAoNiBieXRlczogMHg0RSAweDQxIDB4NTQgMHg0OSAweDU2IDB4NDUpXG4gICAgaXNzdWVyQnl0ZXMgPSBCdWZmZXIuZnJvbSgnTkFUSVZFJywgJ3V0Zi04Jyk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJ0cnKSkge1xuICAgIC8vIFN0ZWxsYXIgcHVibGljIGtleSAoRy4uLiBmb3JtYXQpIC0gZGVjb2RlIHRvIHJhdyAzMiBieXRlc1xuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oU3RyS2V5LmRlY29kZUVkMjU1MTlQdWJsaWNLZXkoaXNzdWVyKSk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJzB4JykpIHtcbiAgICAvLyBSYXcgaGV4IGZvcm1hdCAoZnJvbSBEZXYgQSdzIGNvbnRyYWN0KVxuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oaXNzdWVyLnNsaWNlKDIpLCAnaGV4Jyk7XG4gIH0gZWxzZSB7XG4gICAgLy8gQXNzdW1lIHJhdyBoZXggd2l0aG91dCAweCBwcmVmaXhcbiAgICBpc3N1ZXJCeXRlcyA9IEJ1ZmZlci5mcm9tKGlzc3VlciwgJ2hleCcpO1xuICB9XG5cbiAgLy8gQ29uY2F0ZW5hdGUgYW5kIGhhc2hcbiAgY29uc3QgaW5wdXQgPSBCdWZmZXIuY29uY2F0KFthc3NldENvZGVCeXRlcywgaXNzdWVyQnl0ZXNdKTtcbiAgY29uc3QgaGFzaCA9IHNoYTI1NihpbnB1dCk7XG5cbiAgcmV0dXJuIGhhc2gudG9TdHJpbmcoJ2hleCcpLnRvTG93ZXJDYXNlKCk7XG59XG5cbi8qKlxuICogQ29tcHV0ZSBtZW1vIGFzIHNwZWNpZmllZCBpbiBpbnRlcmZhY2VzLm1kIFNlY3Rpb24gM1xuICpcbiAqIG1lbW8gPSBmaXJzdF8yOF9ieXRlcyhTSEEyNTYoc3VibmV0X2lkIHx8IGJsb2NrX251bWJlcikpXG4gKlxuICogQHBhcmFtIHN1Ym5ldElkIC0gMzItYnl0ZSBzdWJuZXQgSUQgKGJ5dGVzMzIsIGhleCBzdHJpbmcgd2l0aCAweCBwcmVmaXggb3IgcmF3IGhleClcbiAqIEBwYXJhbSBibG9ja051bWJlciAtIEJsb2NrIG51bWJlciAodWludDY0KVxuICogQHJldHVybnMgMjgtYnl0ZSBtZW1vIGFzIEJ1ZmZlclxuICovXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZU1lbW8oc3VibmV0SWQ6IHN0cmluZywgYmxvY2tOdW1iZXI6IGJpZ2ludCk6IEJ1ZmZlciB7XG4gIC8vIHN1Ym5ldF9pZDogMzIgYnl0ZXNcbiAgY29uc3Qgc3VibmV0SWRIZXggPSBzdWJuZXRJZC5zdGFydHNXaXRoKCcweCcpID8gc3VibmV0SWQuc2xpY2UoMikgOiBzdWJuZXRJZDtcbiAgaWYgKHN1Ym5ldElkSGV4Lmxlbmd0aCAhPT0gNjQpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgc3VibmV0X2lkIGxlbmd0aDogZXhwZWN0ZWQgNjQgaGV4IGNoYXJzLCBnb3QgJHtzdWJuZXRJZEhleC5sZW5ndGh9YCk7XG4gIH1cbiAgY29uc3Qgc3VibmV0SWRCeXRlcyA9IEJ1ZmZlci5mcm9tKHN1Ym5ldElkSGV4LCAnaGV4Jyk7XG5cbiAgLy8gYmxvY2tfbnVtYmVyOiB1aW50NjQgYmlnLWVuZGlhbiAoOCBieXRlcylcbiAgY29uc3QgYmxvY2tOdW1iZXJCeXRlcyA9IEJ1ZmZlci5hbGxvYyg4KTtcbiAgYmxvY2tOdW1iZXJCeXRlcy53cml0ZUJpZ1VJbnQ2NEJFKGJsb2NrTnVtYmVyKTtcblxuICAvLyBDb25jYXRlbmF0ZSAoNDAgYnl0ZXMgdG90YWwpXG4gIGNvbnN0IGlucHV0ID0gQnVmZmVyLmNvbmNhdChbc3VibmV0SWRCeXRlcywgYmxvY2tOdW1iZXJCeXRlc10pO1xuXG4gIC8vIFNIQS0yNTYgaGFzaCBhbmQgdGFrZSBmaXJzdCAyOCBieXRlc1xuICBjb25zdCBmdWxsSGFzaCA9IHNoYTI1NihpbnB1dCk7XG4gIHJldHVybiBmdWxsSGFzaC5zdWJhcnJheSgwLCAyOCk7XG59XG5cbi8qKlxuICogQ29udmVydCBhIGJpZ2ludCB0byBhIGJpZy1lbmRpYW4gQnVmZmVyIG9mIHNwZWNpZmllZCBsZW5ndGhcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJpZ2ludFRvQnVmZmVyKHZhbHVlOiBiaWdpbnQsIGxlbmd0aDogbnVtYmVyKTogQnVmZmVyIHtcbiAgY29uc3QgaGV4ID0gdmFsdWUudG9TdHJpbmcoMTYpLnBhZFN0YXJ0KGxlbmd0aCAqIDIsICcwJyk7XG4gIHJldHVybiBCdWZmZXIuZnJvbShoZXgsICdoZXgnKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IGEgQnVmZmVyIHRvIGJpZ2ludCAoYmlnLWVuZGlhbilcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGJ1ZmZlclRvQmlnaW50KGJ1ZmZlcjogQnVmZmVyKTogYmlnaW50IHtcbiAgcmV0dXJuIEJpZ0ludCgnMHgnICsgYnVmZmVyLnRvU3RyaW5nKCdoZXgnKSk7XG59XG5cbi8qKlxuICogQ29udmVydCBTdGVsbGFyIHB1YmxpYyBrZXkgKEcuLi4pIHRvIHJhdyAzMi1ieXRlIEVkMjU1MTkga2V5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBzdGVsbGFyS2V5VG9SYXcocHVibGljS2V5OiBzdHJpbmcpOiBCdWZmZXIge1xuICBpZiAoIXB1YmxpY0tleS5zdGFydHNXaXRoKCdHJykpIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgU3RlbGxhciBwdWJsaWMga2V5IGZvcm1hdCcpO1xuICB9XG4gIHJldHVybiBCdWZmZXIuZnJvbShTdHJLZXkuZGVjb2RlRWQyNTUxOVB1YmxpY0tleShwdWJsaWNLZXkpKTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IHJhdyAzMi1ieXRlIEVkMjU1MTkga2V5IHRvIFN0ZWxsYXIgcHVibGljIGtleSAoRy4uLilcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHJhd1RvU3RlbGxhcktleShyYXdLZXk6IEJ1ZmZlcik6IHN0cmluZyB7XG4gIGlmIChyYXdLZXkubGVuZ3RoICE9PSAzMikge1xuICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCByYXcga2V5IGxlbmd0aDogZXhwZWN0ZWQgMzIgYnl0ZXMnKTtcbiAgfVxuICByZXR1cm4gU3RyS2V5LmVuY29kZUVkMjU1MTlQdWJsaWNLZXkocmF3S2V5KTtcbn1cblxuLyoqXG4gKiBDb252ZXJ0IGhleCBzdHJpbmcgKHdpdGggb3Igd2l0aG91dCAweCkgdG8gU3RlbGxhciBwdWJsaWMga2V5XG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBoZXhUb1N0ZWxsYXJLZXkoaGV4OiBzdHJpbmcpOiBzdHJpbmcge1xuICBjb25zdCBjbGVhbkhleCA9IGhleC5zdGFydHNXaXRoKCcweCcpID8gaGV4LnNsaWNlKDIpIDogaGV4O1xuICBpZiAoY2xlYW5IZXgubGVuZ3RoICE9PSA2NCkge1xuICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBoZXggbGVuZ3RoOiBleHBlY3RlZCA2NCwgZ290ICR7Y2xlYW5IZXgubGVuZ3RofWApO1xuICB9XG4gIHJldHVybiByYXdUb1N0ZWxsYXJLZXkoQnVmZmVyLmZyb20oY2xlYW5IZXgsICdoZXgnKSk7XG59XG5cbi8qKlxuICogVmFsaWRhdGUgdGhhdCBhIHN0cmluZyBpcyBhIHZhbGlkIFN0ZWxsYXIgcHVibGljIGtleVxuICovXG5leHBvcnQgZnVuY3Rpb24gaXNWYWxpZFN0ZWxsYXJQdWJsaWNLZXkoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgdHJ5IHtcbiAgICBTdHJLZXkuZGVjb2RlRWQyNTUxOVB1YmxpY0tleShrZXkpO1xuICAgIHJldHVybiB0cnVlO1xuICB9IGNhdGNoIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbn1cblxuLyoqXG4gKiBDb21wdXRlIGJhbGFuY2UgbGVhZiBoYXNoIGFzIHNwZWNpZmllZCBpbiBpbnRlcmZhY2VzLm1kIFNlY3Rpb24gMS4zXG4gKlxuICogYmFsYW5jZV9sZWFmID0gU0hBMjU2KFwiQkFMXCIgfHwgdXNlcl9pZCB8fCBhc3NldF9jb2RlIHx8IGlzc3VlciB8fCBiYWxhbmNlKVxuICovXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZUJhbGFuY2VMZWFmKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgYXNzZXRDb2RlOiBzdHJpbmcsXG4gIGlzc3Vlcjogc3RyaW5nLFxuICBiYWxhbmNlOiBiaWdpbnRcbik6IHN0cmluZyB7XG4gIC8vIFByZWZpeDogXCJCQUxcIiAoMyBieXRlczogMHg0MiAweDQxIDB4NEMpXG4gIGNvbnN0IHByZWZpeCA9IEJ1ZmZlci5mcm9tKCdCQUwnLCAndXRmLTgnKTtcblxuICAvLyB1c2VyX2lkOiAzMiBieXRlc1xuICBjb25zdCB1c2VySWRIZXggPSB1c2VySWQuc3RhcnRzV2l0aCgnMHgnKSA/IHVzZXJJZC5zbGljZSgyKSA6IHVzZXJJZDtcbiAgY29uc3QgdXNlcklkQnl0ZXMgPSBCdWZmZXIuZnJvbSh1c2VySWRIZXgsICdoZXgnKTtcblxuICAvLyBhc3NldF9jb2RlOiBVVEYtOCBlbmNvZGVkLCBudWxsLXRlcm1pbmF0ZWRcbiAgY29uc3QgYXNzZXRDb2RlQnl0ZXMgPSBCdWZmZXIuY29uY2F0KFtcbiAgICBCdWZmZXIuZnJvbShhc3NldENvZGUsICd1dGYtOCcpLFxuICAgIEJ1ZmZlci5mcm9tKFsweDAwXSksXG4gIF0pO1xuXG4gIC8vIGlzc3VlcjogXCJOQVRJVkVcIiBmb3IgWExNIG9yIDMyLWJ5dGUgRWQyNTUxOSBwdWJsaWMga2V5XG4gIGxldCBpc3N1ZXJCeXRlczogQnVmZmVyO1xuICBpZiAoaXNzdWVyLnRvVXBwZXJDYXNlKCkgPT09ICdOQVRJVkUnKSB7XG4gICAgaXNzdWVyQnl0ZXMgPSBCdWZmZXIuZnJvbSgnTkFUSVZFJywgJ3V0Zi04Jyk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJ0cnKSkge1xuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oU3RyS2V5LmRlY29kZUVkMjU1MTlQdWJsaWNLZXkoaXNzdWVyKSk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJzB4JykpIHtcbiAgICBpc3N1ZXJCeXRlcyA9IEJ1ZmZlci5mcm9tKGlzc3Vlci5zbGljZSgyKSwgJ2hleCcpO1xuICB9IGVsc2Uge1xuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oaXNzdWVyLCAnaGV4Jyk7XG4gIH1cblxuICAvLyBiYWxhbmNlOiAxNiBieXRlcyBiaWctZW5kaWFuIGludDEyOFxuICBjb25zdCBiYWxhbmNlQnl0ZXMgPSBiaWdpbnRUb0J1ZmZlcihiYWxhbmNlLCAxNik7XG5cbiAgLy8gQ29uY2F0ZW5hdGUgYW5kIGhhc2hcbiAgY29uc3QgaW5wdXQgPSBCdWZmZXIuY29uY2F0KFtwcmVmaXgsIHVzZXJJZEJ5dGVzLCBhc3NldENvZGVCeXRlcywgaXNzdWVyQnl0ZXMsIGJhbGFuY2VCeXRlc10pO1xuICByZXR1cm4gc2hhMjU2KGlucHV0KS50b1N0cmluZygnaGV4JykudG9Mb3dlckNhc2UoKTtcbn1cblxuLyoqXG4gKiBDb21wdXRlIHdpdGhkcmF3YWwgbGVhZiBoYXNoIGFzIHNwZWNpZmllZCBpbiBpbnRlcmZhY2VzLm1kIFNlY3Rpb24gMS40XG4gKlxuICogd2l0aGRyYXdhbF9sZWFmID0gU0hBMjU2KFwiV0RcIiB8fCB3aXRoZHJhd2FsX2lkIHx8IHVzZXJfaWQgfHwgYXNzZXRfY29kZSB8fCBpc3N1ZXIgfHwgYW1vdW50IHx8IGRlc3RpbmF0aW9uKVxuICovXG5leHBvcnQgZnVuY3Rpb24gY29tcHV0ZVdpdGhkcmF3YWxMZWFmKFxuICB3aXRoZHJhd2FsSWQ6IHN0cmluZyxcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGFzc2V0Q29kZTogc3RyaW5nLFxuICBpc3N1ZXI6IHN0cmluZyxcbiAgYW1vdW50OiBiaWdpbnQsXG4gIGRlc3RpbmF0aW9uOiBzdHJpbmdcbik6IHN0cmluZyB7XG4gIC8vIFByZWZpeDogXCJXRFwiICgyIGJ5dGVzOiAweDU3IDB4NDQpXG4gIGNvbnN0IHByZWZpeCA9IEJ1ZmZlci5mcm9tKCdXRCcsICd1dGYtOCcpO1xuXG4gIC8vIHdpdGhkcmF3YWxfaWQ6IDMyIGJ5dGVzXG4gIGNvbnN0IHdpdGhkcmF3YWxJZEhleCA9IHdpdGhkcmF3YWxJZC5zdGFydHNXaXRoKCcweCcpID8gd2l0aGRyYXdhbElkLnNsaWNlKDIpIDogd2l0aGRyYXdhbElkO1xuICBjb25zdCB3aXRoZHJhd2FsSWRCeXRlcyA9IEJ1ZmZlci5mcm9tKHdpdGhkcmF3YWxJZEhleCwgJ2hleCcpO1xuXG4gIC8vIHVzZXJfaWQ6IDMyIGJ5dGVzXG4gIGNvbnN0IHVzZXJJZEhleCA9IHVzZXJJZC5zdGFydHNXaXRoKCcweCcpID8gdXNlcklkLnNsaWNlKDIpIDogdXNlcklkO1xuICBjb25zdCB1c2VySWRCeXRlcyA9IEJ1ZmZlci5mcm9tKHVzZXJJZEhleCwgJ2hleCcpO1xuXG4gIC8vIGFzc2V0X2NvZGU6IFVURi04IGVuY29kZWQsIG51bGwtdGVybWluYXRlZFxuICBjb25zdCBhc3NldENvZGVCeXRlcyA9IEJ1ZmZlci5jb25jYXQoW1xuICAgIEJ1ZmZlci5mcm9tKGFzc2V0Q29kZSwgJ3V0Zi04JyksXG4gICAgQnVmZmVyLmZyb20oWzB4MDBdKSxcbiAgXSk7XG5cbiAgLy8gaXNzdWVyXG4gIGxldCBpc3N1ZXJCeXRlczogQnVmZmVyO1xuICBpZiAoaXNzdWVyLnRvVXBwZXJDYXNlKCkgPT09ICdOQVRJVkUnKSB7XG4gICAgaXNzdWVyQnl0ZXMgPSBCdWZmZXIuZnJvbSgnTkFUSVZFJywgJ3V0Zi04Jyk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJ0cnKSkge1xuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oU3RyS2V5LmRlY29kZUVkMjU1MTlQdWJsaWNLZXkoaXNzdWVyKSk7XG4gIH0gZWxzZSBpZiAoaXNzdWVyLnN0YXJ0c1dpdGgoJzB4JykpIHtcbiAgICBpc3N1ZXJCeXRlcyA9IEJ1ZmZlci5mcm9tKGlzc3Vlci5zbGljZSgyKSwgJ2hleCcpO1xuICB9IGVsc2Uge1xuICAgIGlzc3VlckJ5dGVzID0gQnVmZmVyLmZyb20oaXNzdWVyLCAnaGV4Jyk7XG4gIH1cblxuICAvLyBhbW91bnQ6IDE2IGJ5dGVzIGJpZy1lbmRpYW4gaW50MTI4XG4gIGNvbnN0IGFtb3VudEJ5dGVzID0gYmlnaW50VG9CdWZmZXIoYW1vdW50LCAxNik7XG5cbiAgLy8gZGVzdGluYXRpb246IDMyIGJ5dGVzIEVkMjU1MTkgcHVibGljIGtleVxuICBsZXQgZGVzdGluYXRpb25CeXRlczogQnVmZmVyO1xuICBpZiAoZGVzdGluYXRpb24uc3RhcnRzV2l0aCgnRycpKSB7XG4gICAgZGVzdGluYXRpb25CeXRlcyA9IEJ1ZmZlci5mcm9tKFN0cktleS5kZWNvZGVFZDI1NTE5UHVibGljS2V5KGRlc3RpbmF0aW9uKSk7XG4gIH0gZWxzZSBpZiAoZGVzdGluYXRpb24uc3RhcnRzV2l0aCgnMHgnKSkge1xuICAgIGRlc3RpbmF0aW9uQnl0ZXMgPSBCdWZmZXIuZnJvbShkZXN0aW5hdGlvbi5zbGljZSgyKSwgJ2hleCcpO1xuICB9IGVsc2Uge1xuICAgIGRlc3RpbmF0aW9uQnl0ZXMgPSBCdWZmZXIuZnJvbShkZXN0aW5hdGlvbiwgJ2hleCcpO1xuICB9XG5cbiAgLy8gQ29uY2F0ZW5hdGUgYW5kIGhhc2hcbiAgY29uc3QgaW5wdXQgPSBCdWZmZXIuY29uY2F0KFtcbiAgICBwcmVmaXgsXG4gICAgd2l0aGRyYXdhbElkQnl0ZXMsXG4gICAgdXNlcklkQnl0ZXMsXG4gICAgYXNzZXRDb2RlQnl0ZXMsXG4gICAgaXNzdWVyQnl0ZXMsXG4gICAgYW1vdW50Qnl0ZXMsXG4gICAgZGVzdGluYXRpb25CeXRlcyxcbiAgXSk7XG4gIHJldHVybiBzaGEyNTYoaW5wdXQpLnRvU3RyaW5nKCdoZXgnKS50b0xvd2VyQ2FzZSgpO1xufVxuIl19