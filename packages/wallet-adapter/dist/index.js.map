{"version":3,"sources":["../src/keys/derivation.ts","../src/adapter/metamask.ts"],"names":["sha256","Keypair","StrKey","keccak_256","EventEmitter"],"mappings":"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","file":"index.js","sourcesContent":["/**\n * TVA Wallet Key Derivation\n *\n * Handles deterministic derivation of Stellar Ed25519 keys from\n * EVM secp256k1 keys. This allows users to control both their\n * EVM and Stellar identities from a single wallet (MetaMask).\n */\n\nimport { Keypair, StrKey } from '@stellar/stellar-sdk';\nimport { sha256 } from '@noble/hashes/sha256';\nimport { keccak_256 } from '@noble/hashes/sha3';\nimport type { StellarAddress, EvmAddress } from '@tva-protocol/sdk';\n\n/**\n * Domain separator for TVA key derivation\n * This ensures our derived keys don't collide with other protocols\n */\nconst TVA_KEY_DERIVATION_DOMAIN = 'TVA-STELLAR-KEY-DERIVATION-V1';\n\n/**\n * Derives a Stellar keypair from an EVM private key or signature\n *\n * There are two modes:\n * 1. Direct derivation from private key (for server-side/testing)\n * 2. Signature-based derivation (for browser with MetaMask)\n */\nexport function deriveStellarKeypairFromEvmKey(\n  evmPrivateKey: string\n): Keypair {\n  const privateKeyBytes = Buffer.from(\n    evmPrivateKey.replace(/^0x/, ''),\n    'hex'\n  );\n\n  // Create deterministic seed by hashing the private key with our domain\n  const seed = sha256(\n    new Uint8Array([\n      ...new TextEncoder().encode(TVA_KEY_DERIVATION_DOMAIN),\n      ...privateKeyBytes,\n    ])\n  );\n\n  return Keypair.fromRawEd25519Seed(Buffer.from(seed));\n}\n\n/**\n * Derives a Stellar keypair from a signed message\n *\n * This is the browser-compatible method where:\n * 1. User signs a deterministic message with MetaMask\n * 2. The signature is used as entropy to derive the Stellar key\n *\n * The message is deterministic so the same wallet always derives\n * the same Stellar keypair.\n */\nexport function deriveStellarKeypairFromSignature(\n  signature: string\n): Keypair {\n  const signatureBytes = Buffer.from(signature.replace(/^0x/, ''), 'hex');\n\n  // Hash the signature to create a 32-byte seed\n  const seed = sha256(\n    new Uint8Array([\n      ...new TextEncoder().encode(TVA_KEY_DERIVATION_DOMAIN),\n      ...signatureBytes,\n    ])\n  );\n\n  return Keypair.fromRawEd25519Seed(Buffer.from(seed));\n}\n\n/**\n * Gets the deterministic message that should be signed for key derivation\n *\n * @param evmAddress - The user's EVM address\n * @param nonce - Optional nonce for key rotation (default 0)\n */\nexport function getKeyDerivationMessage(\n  evmAddress: EvmAddress,\n  nonce: number = 0\n): string {\n  return [\n    'TVA Protocol Key Derivation',\n    '',\n    'This signature will be used to derive your Stellar keypair.',\n    'This allows you to use your Ethereum wallet with Stellar/Soroban.',\n    '',\n    'EVM Address: ' + evmAddress,\n    'Nonce: ' + nonce,\n    '',\n    'WARNING: Only sign this message on trusted TVA Protocol applications.',\n    'This signature can derive your Stellar private key.',\n  ].join('\\n');\n}\n\n/**\n * Gets the EIP-712 typed data for key derivation\n * This is more secure and shows clear intent in MetaMask\n */\nexport function getKeyDerivationTypedData(\n  evmAddress: EvmAddress,\n  chainId: number,\n  nonce: number = 0\n) {\n  return {\n    domain: {\n      name: 'TVA Protocol',\n      version: '1',\n      chainId,\n      verifyingContract: '0x0000000000000000000000000000000000000000', // No contract\n    },\n    types: {\n      KeyDerivation: [\n        { name: 'evmAddress', type: 'address' },\n        { name: 'nonce', type: 'uint256' },\n        { name: 'purpose', type: 'string' },\n      ],\n    },\n    primaryType: 'KeyDerivation' as const,\n    message: {\n      evmAddress,\n      nonce,\n      purpose: 'Derive Stellar keypair for TVA Protocol',\n    },\n  };\n}\n\n/**\n * Converts an EVM address to a pseudo-Stellar address for display\n * This is NOT a real Stellar address - just for UI consistency\n */\nexport function evmAddressToDisplayAddress(evmAddress: EvmAddress): string {\n  // Format EVM address as a TVA display address\n  return `TVA:${evmAddress.slice(2, 10).toUpperCase()}...${evmAddress.slice(-8).toUpperCase()}`;\n}\n\n/**\n * Validates that a Stellar address was derived from an EVM address\n * by checking the derivation path\n */\nexport async function validateDerivedAddress(\n  evmAddress: EvmAddress,\n  stellarAddress: StellarAddress,\n  signFunction: (message: string) => Promise<string>\n): Promise<boolean> {\n  // Sign the derivation message\n  const message = getKeyDerivationMessage(evmAddress);\n  const signature = await signFunction(message);\n\n  // Derive the expected Stellar keypair\n  const derivedKeypair = deriveStellarKeypairFromSignature(signature);\n\n  // Compare addresses\n  return derivedKeypair.publicKey() === stellarAddress;\n}\n\n/**\n * Gets the raw Ed25519 public key bytes from a Stellar address\n */\nexport function stellarAddressToPublicKeyBytes(\n  address: StellarAddress\n): Uint8Array {\n  return StrKey.decodeEd25519PublicKey(address);\n}\n\n/**\n * Creates a Stellar address from Ed25519 public key bytes\n */\nexport function publicKeyBytesToStellarAddress(\n  publicKey: Uint8Array\n): StellarAddress {\n  return StrKey.encodeEd25519PublicKey(Buffer.from(publicKey)) as StellarAddress;\n}\n\n/**\n * Computes the EVM address from a public key\n */\nexport function computeEvmAddress(publicKey: Uint8Array): EvmAddress {\n  // Remove 0x04 prefix if present (uncompressed key marker)\n  const key = publicKey.length === 65 ? publicKey.slice(1) : publicKey;\n\n  // Keccak256 hash and take last 20 bytes\n  const hash = keccak_256(key);\n  const addressBytes = hash.slice(-20);\n\n  return `0x${Buffer.from(addressBytes).toString('hex')}` as EvmAddress;\n}\n","/**\n * TVA MetaMask Wallet Adapter\n *\n * Enables MetaMask and other EVM-compatible wallets to work with TVA Protocol.\n * Handles the dual-key challenge by deriving Stellar keys from MetaMask signatures.\n */\n\nimport { EventEmitter } from 'eventemitter3';\nimport { Keypair, Transaction } from '@stellar/stellar-sdk';\nimport {\n  deriveStellarKeypairFromSignature,\n  getKeyDerivationMessage,\n} from '../keys/derivation.js';\nimport type { EvmAddress, StellarAddress, NetworkType, NetworkConfig } from '@tva-protocol/sdk';\n\n/**\n * Ethereum provider interface (injected by MetaMask)\n */\ninterface EthereumProvider {\n  isMetaMask?: boolean;\n  request: (args: { method: string; params?: any[] }) => Promise<any>;\n  on: (event: string, callback: (...args: any[]) => void) => void;\n  removeListener: (event: string, callback: (...args: any[]) => void) => void;\n  selectedAddress: string | null;\n  chainId: string;\n}\n\n/**\n * Adapter events\n */\ninterface TVAWalletAdapterEvents {\n  connect: (address: EvmAddress) => void;\n  disconnect: () => void;\n  accountsChanged: (accounts: EvmAddress[]) => void;\n  chainChanged: (chainId: number) => void;\n  stellarKeyDerived: (address: StellarAddress) => void;\n  error: (error: Error) => void;\n}\n\n/**\n * Connection state\n */\nexport interface ConnectionState {\n  connected: boolean;\n  evmAddress: EvmAddress | null;\n  stellarAddress: StellarAddress | null;\n  stellarKeypair: Keypair | null;\n  chainId: number | null;\n  isRegistered: boolean;\n}\n\n/**\n * TVA MetaMask Wallet Adapter\n */\nexport class TVAWalletAdapter extends EventEmitter<TVAWalletAdapterEvents> {\n  private provider: EthereumProvider | null = null;\n  private stellarKeypair: Keypair | null = null;\n  private evmAddress: EvmAddress | null = null;\n  private chainId: number | null = null;\n  private isRegistered: boolean = false;\n\n  /**\n   * TVA network configuration\n   */\n  private networkConfig: NetworkConfig;\n\n  constructor(network: NetworkType = 'testnet') {\n    super();\n    // Import NETWORKS dynamically to avoid circular dependencies\n    this.networkConfig = {\n      type: network,\n      rpcUrl: network === 'testnet'\n        ? 'https://rpc.testnet.tva-protocol.io'\n        : network === 'mainnet'\n        ? 'https://rpc.tva-protocol.io'\n        : 'http://localhost:8545',\n      horizonUrl: network === 'testnet'\n        ? 'https://horizon-testnet.stellar.org'\n        : network === 'mainnet'\n        ? 'https://horizon.stellar.org'\n        : 'http://localhost:8000',\n      sorobanRpcUrl: network === 'testnet'\n        ? 'https://soroban-testnet.stellar.org'\n        : network === 'mainnet'\n        ? 'https://soroban.stellar.org'\n        : 'http://localhost:8001',\n      networkPassphrase: network === 'testnet'\n        ? 'Test SDF Network ; September 2015'\n        : network === 'mainnet'\n        ? 'Public Global Stellar Network ; September 2015'\n        : 'Standalone Network ; February 2017',\n      chainId: network === 'testnet' ? 0x544541 : network === 'mainnet' ? 0x545641 : 0x545600,\n      nativeCurrency: {\n        name: 'Stellar Lumens',\n        symbol: 'XLM',\n        decimals: 7,\n      },\n    };\n  }\n\n  /**\n   * Checks if MetaMask is available\n   */\n  isAvailable(): boolean {\n    return typeof window !== 'undefined' && !!(window as any).ethereum;\n  }\n\n  /**\n   * Gets the current connection state\n   */\n  getState(): ConnectionState {\n    return {\n      connected: !!this.evmAddress,\n      evmAddress: this.evmAddress,\n      stellarAddress: this.stellarKeypair?.publicKey() as StellarAddress | null,\n      stellarKeypair: this.stellarKeypair,\n      chainId: this.chainId,\n      isRegistered: this.isRegistered,\n    };\n  }\n\n  /**\n   * Connects to MetaMask and derives Stellar keypair\n   */\n  async connect(): Promise<ConnectionState> {\n    if (!this.isAvailable()) {\n      throw new Error('MetaMask is not installed');\n    }\n\n    this.provider = (window as any).ethereum as EthereumProvider;\n\n    try {\n      // Request account access\n      const accounts = await this.provider.request({\n        method: 'eth_requestAccounts',\n      });\n\n      if (accounts.length === 0) {\n        throw new Error('No accounts found');\n      }\n\n      this.evmAddress = accounts[0] as EvmAddress;\n      this.chainId = parseInt(this.provider.chainId, 16);\n\n      // Set up event listeners\n      this.setupEventListeners();\n\n      this.emit('connect', this.evmAddress);\n\n      // Derive Stellar keypair\n      await this.deriveAndStoreStellarKey();\n\n      return this.getState();\n    } catch (error) {\n      this.emit('error', error as Error);\n      throw error;\n    }\n  }\n\n  /**\n   * Disconnects from the wallet\n   */\n  async disconnect(): Promise<void> {\n    this.evmAddress = null;\n    this.stellarKeypair = null;\n    this.chainId = null;\n    this.isRegistered = false;\n\n    if (this.provider) {\n      this.removeEventListeners();\n    }\n\n    this.emit('disconnect');\n  }\n\n  /**\n   * Derives the Stellar keypair by requesting a signature from MetaMask\n   */\n  async deriveAndStoreStellarKey(): Promise<Keypair> {\n    if (!this.provider || !this.evmAddress) {\n      throw new Error('Wallet not connected');\n    }\n\n    // Get the derivation message\n    const message = getKeyDerivationMessage(this.evmAddress);\n\n    // Request signature from MetaMask\n    const signature = await this.signMessage(message);\n\n    // Derive Stellar keypair from signature\n    this.stellarKeypair = deriveStellarKeypairFromSignature(signature);\n\n    this.emit('stellarKeyDerived', this.stellarKeypair.publicKey() as StellarAddress);\n\n    return this.stellarKeypair;\n  }\n\n  /**\n   * Signs a message with MetaMask (personal_sign)\n   */\n  async signMessage(message: string): Promise<string> {\n    if (!this.provider || !this.evmAddress) {\n      throw new Error('Wallet not connected');\n    }\n\n    return this.provider.request({\n      method: 'personal_sign',\n      params: [\n        `0x${Buffer.from(message).toString('hex')}`,\n        this.evmAddress,\n      ],\n    });\n  }\n\n  /**\n   * Signs typed data with MetaMask (EIP-712)\n   */\n  async signTypedData(typedData: any): Promise<string> {\n    if (!this.provider || !this.evmAddress) {\n      throw new Error('Wallet not connected');\n    }\n\n    return this.provider.request({\n      method: 'eth_signTypedData_v4',\n      params: [this.evmAddress, JSON.stringify(typedData)],\n    });\n  }\n\n  /**\n   * Signs an EVM transaction\n   */\n  async signEvmTransaction(tx: any): Promise<string> {\n    if (!this.provider) {\n      throw new Error('Wallet not connected');\n    }\n\n    return this.provider.request({\n      method: 'eth_sendTransaction',\n      params: [tx],\n    });\n  }\n\n  /**\n   * Signs a Stellar transaction using the derived keypair\n   */\n  signStellarTransaction(transaction: Transaction): Transaction {\n    if (!this.stellarKeypair) {\n      throw new Error('Stellar keypair not derived. Call deriveAndStoreStellarKey() first.');\n    }\n\n    transaction.sign(this.stellarKeypair);\n    return transaction;\n  }\n\n  /**\n   * Signs arbitrary data with the Stellar keypair\n   */\n  signWithStellarKey(data: Uint8Array): Uint8Array {\n    if (!this.stellarKeypair) {\n      throw new Error('Stellar keypair not derived');\n    }\n\n    return this.stellarKeypair.sign(Buffer.from(data));\n  }\n\n  /**\n   * Switches to the TVA network in MetaMask\n   */\n  async switchToTVANetwork(): Promise<void> {\n    if (!this.provider) {\n      throw new Error('Wallet not connected');\n    }\n\n    const chainIdHex = `0x${this.networkConfig.chainId.toString(16)}`;\n\n    try {\n      await this.provider.request({\n        method: 'wallet_switchEthereumChain',\n        params: [{ chainId: chainIdHex }],\n      });\n    } catch (error: any) {\n      // Chain doesn't exist, add it\n      if (error.code === 4902) {\n        await this.addTVANetwork();\n      } else {\n        throw error;\n      }\n    }\n  }\n\n  /**\n   * Adds the TVA network to MetaMask\n   */\n  async addTVANetwork(): Promise<void> {\n    if (!this.provider) {\n      throw new Error('Wallet not connected');\n    }\n\n    const chainIdHex = `0x${this.networkConfig.chainId.toString(16)}`;\n\n    await this.provider.request({\n      method: 'wallet_addEthereumChain',\n      params: [\n        {\n          chainId: chainIdHex,\n          chainName: `TVA Protocol ${this.networkConfig.type}`,\n          nativeCurrency: this.networkConfig.nativeCurrency,\n          rpcUrls: [this.networkConfig.rpcUrl],\n          blockExplorerUrls: [`https://explorer.tva-protocol.io`],\n        },\n      ],\n    });\n  }\n\n  /**\n   * Gets the current chain ID\n   */\n  async getChainId(): Promise<number> {\n    if (!this.provider) {\n      throw new Error('Wallet not connected');\n    }\n\n    const chainId = await this.provider.request({ method: 'eth_chainId' });\n    return parseInt(chainId, 16);\n  }\n\n  /**\n   * Gets the connected accounts\n   */\n  async getAccounts(): Promise<EvmAddress[]> {\n    if (!this.provider) {\n      throw new Error('Wallet not connected');\n    }\n\n    return this.provider.request({ method: 'eth_accounts' });\n  }\n\n  /**\n   * Gets the balance of the connected account\n   */\n  async getBalance(): Promise<bigint> {\n    if (!this.provider || !this.evmAddress) {\n      throw new Error('Wallet not connected');\n    }\n\n    const balance = await this.provider.request({\n      method: 'eth_getBalance',\n      params: [this.evmAddress, 'latest'],\n    });\n\n    return BigInt(balance);\n  }\n\n  /**\n   * Sets up event listeners for MetaMask events\n   */\n  private setupEventListeners(): void {\n    if (!this.provider) return;\n\n    this.provider.on('accountsChanged', this.handleAccountsChanged);\n    this.provider.on('chainChanged', this.handleChainChanged);\n    this.provider.on('disconnect', this.handleDisconnect);\n  }\n\n  /**\n   * Removes event listeners\n   */\n  private removeEventListeners(): void {\n    if (!this.provider) return;\n\n    this.provider.removeListener('accountsChanged', this.handleAccountsChanged);\n    this.provider.removeListener('chainChanged', this.handleChainChanged);\n    this.provider.removeListener('disconnect', this.handleDisconnect);\n  }\n\n  /**\n   * Handles account changes\n   */\n  private handleAccountsChanged = (accounts: string[]): void => {\n    if (accounts.length === 0) {\n      this.disconnect();\n    } else {\n      this.evmAddress = accounts[0] as EvmAddress;\n      this.stellarKeypair = null; // Need to re-derive for new account\n      this.emit('accountsChanged', accounts as EvmAddress[]);\n    }\n  };\n\n  /**\n   * Handles chain changes\n   */\n  private handleChainChanged = (chainId: string): void => {\n    this.chainId = parseInt(chainId, 16);\n    this.emit('chainChanged', this.chainId);\n  };\n\n  /**\n   * Handles disconnection\n   */\n  private handleDisconnect = (): void => {\n    this.disconnect();\n  };\n}\n\n/**\n * Singleton instance for easy access\n */\nlet walletAdapterInstance: TVAWalletAdapter | null = null;\n\n/**\n * Gets or creates the wallet adapter instance\n */\nexport function getWalletAdapter(network: NetworkType = 'testnet'): TVAWalletAdapter {\n  if (!walletAdapterInstance) {\n    walletAdapterInstance = new TVAWalletAdapter(network);\n  }\n  return walletAdapterInstance;\n}\n\n/**\n * Resets the wallet adapter instance (for testing)\n */\nexport function resetWalletAdapter(): void {\n  if (walletAdapterInstance) {\n    walletAdapterInstance.disconnect();\n    walletAdapterInstance = null;\n  }\n}\n"]}